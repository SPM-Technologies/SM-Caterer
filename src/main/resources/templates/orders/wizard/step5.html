<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title th:text="#{orders.wizard.step5}">Summary</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0"><i class="bi bi-receipt"></i> <span th:text="#{orders.newOrder}">New Order</span></h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/orders}" th:text="#{orders.title}">Orders</a></li>
                    <li class="breadcrumb-item active" th:text="#{orders.wizard.step5}">Step 5</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Wizard Progress -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div class="wizard-step completed"><span class="badge bg-success rounded-circle"><i class="bi bi-check"></i></span> <span class="ms-2" th:text="#{orders.wizard.customer}">Customer</span></div>
                <div class="wizard-step completed"><span class="badge bg-success rounded-circle"><i class="bi bi-check"></i></span> <span class="ms-2" th:text="#{orders.wizard.event}">Event</span></div>
                <div class="wizard-step completed"><span class="badge bg-success rounded-circle"><i class="bi bi-check"></i></span> <span class="ms-2" th:text="#{orders.wizard.menu}">Menu</span></div>
                <div class="wizard-step completed"><span class="badge bg-success rounded-circle"><i class="bi bi-check"></i></span> <span class="ms-2" th:text="#{orders.wizard.utilities}">Utilities</span></div>
                <div class="wizard-step active"><span class="badge bg-primary rounded-circle">5</span> <span class="ms-2" th:text="#{orders.wizard.summary}">Summary</span></div>
            </div>
        </div>
    </div>

    <form th:action="@{/orders/wizard/step5}" method="post" th:object="${form}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="row">
            <!-- Order Summary -->
            <div class="col-lg-8">
                <!-- Customer Summary -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="card-title mb-0"><i class="bi bi-person"></i> <span th:text="#{orders.customer}">Customer</span></h5>
                        <a th:href="@{/orders/wizard/step1}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <strong th:text="${form.customerName}">Customer Name</strong>
                        <span class="text-muted"> (<span th:text="${form.customerCode}">CUST-001</span>)</span><br>
                        <i class="bi bi-telephone"></i> <span th:text="${form.customerPhone}">9876543210</span>
                    </div>
                </div>

                <!-- Event Summary -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="card-title mb-0"><i class="bi bi-calendar-event"></i> <span th:text="#{orders.event}">Event</span></h5>
                        <a th:href="@{/orders/wizard/step2}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p class="text-muted mb-0" th:text="#{orders.eventType}">Event Type</p>
                                <strong th:text="${form.eventTypeName}">Wedding</strong>
                            </div>
                            <div class="col-md-4">
                                <p class="text-muted mb-0" th:text="#{orders.eventDate}">Date</p>
                                <strong th:text="${#temporals.format(form.eventDate, 'dd MMM yyyy')}">01 Jan 2024</strong>
                            </div>
                            <div class="col-md-4">
                                <p class="text-muted mb-0" th:text="#{orders.guestCount}">Guests</p>
                                <strong th:text="${form.guestCount}">100</strong>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col">
                                <p class="text-muted mb-0" th:text="#{orders.venue}">Venue</p>
                                <strong th:text="${form.venueName}">Venue Name</strong>
                                <span class="text-muted" th:if="${form.venueAddress}" th:text="' - ' + ${form.venueAddress}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Items Summary -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="card-title mb-0"><i class="bi bi-card-list"></i> <span th:text="#{orders.menuItems}">Menu Items</span></h5>
                        <a th:href="@{/orders/wizard/step3}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                            <tr>
                                <th th:text="#{orders.menu}">Menu</th>
                                <th class="text-end" th:text="#{orders.quantity}">Qty</th>
                                <th class="text-end" th:text="#{orders.pricePerItem}">Price</th>
                                <th class="text-end" th:text="#{orders.subtotal}">Subtotal</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${form.menuItems}">
                                <td th:text="${item.menuName ?: item.menuCode}">Menu</td>
                                <td class="text-end" th:text="${item.quantity}">10</td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.pricePerItem)}">100</td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.subtotal)}">1000</td>
                            </tr>
                            </tbody>
                            <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end fw-bold" th:text="#{orders.menuSubtotal}">Menu Subtotal</td>
                                <td class="text-end fw-bold" th:text="${#numbers.formatCurrency(form.menuSubtotal)}">5000</td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Utilities Summary -->
                <div class="card border-0 shadow-sm mb-4" th:if="${!#lists.isEmpty(form.utilities)}">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="card-title mb-0"><i class="bi bi-tools"></i> <span th:text="#{orders.utilities}">Utilities</span></h5>
                        <a th:href="@{/orders/wizard/step4}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                            <tr>
                                <th th:text="#{orders.utility}">Utility</th>
                                <th class="text-end" th:text="#{orders.quantity}">Qty</th>
                                <th class="text-end" th:text="#{orders.pricePerUnit}">Price</th>
                                <th class="text-end" th:text="#{orders.subtotal}">Subtotal</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${form.utilities}">
                                <td th:text="${item.utilityName ?: item.utilityCode}">Utility</td>
                                <td class="text-end" th:text="${item.quantity}">5</td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.pricePerUnit)}">50</td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.subtotal)}">250</td>
                            </tr>
                            </tbody>
                            <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end fw-bold" th:text="#{orders.utilitySubtotal}">Utility Subtotal</td>
                                <td class="text-end fw-bold" th:text="${#numbers.formatCurrency(form.utilitySubtotal)}">500</td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0"><i class="bi bi-sticky"></i> <span th:text="#{orders.notes}">Notes</span></h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" name="notes" rows="3" th:text="${form.notes}"
                                  th:placeholder="#{orders.notesPlaceholder}"></textarea>
                    </div>
                </div>
            </div>

            <!-- Pricing Sidebar -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 80px;">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0"><i class="bi bi-calculator"></i> <span th:text="#{orders.pricing}">Pricing</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span th:text="#{orders.menuSubtotal}">Menu Subtotal</span>
                            <span id="displayMenuSubtotal" th:text="${#numbers.formatCurrency(form.menuSubtotal)}">5000</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span th:text="#{orders.utilitySubtotal}">Utility Subtotal</span>
                            <span id="displayUtilitySubtotal" th:text="${#numbers.formatCurrency(form.utilitySubtotal)}">500</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span th:text="#{orders.subtotal}">Subtotal</span>
                            <span id="displaySubtotal" th:text="${#numbers.formatCurrency(form.subtotal)}">5500</span>
                        </div>

                        <!-- Discount -->
                        <div class="mb-3">
                            <label class="form-label" th:text="#{orders.discountPercent}">Discount (%)</label>
                            <input type="number" class="form-control form-control-sm" name="discountPercent" id="discountPercent"
                                   th:value="${form.discountPercent}" min="0" max="100" step="0.01" onchange="recalculate()">
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-danger">
                            <span th:text="#{orders.discount}">Discount</span>
                            <span id="displayDiscount" th:text="'-' + ${#numbers.formatCurrency(form.discountAmount)}">-0</span>
                        </div>

                        <!-- Tax -->
                        <div class="mb-3">
                            <label class="form-label" th:text="#{orders.taxPercent}">Tax (%)</label>
                            <input type="number" class="form-control form-control-sm" name="taxPercent" id="taxPercent"
                                   th:value="${form.taxPercent}" min="0" max="100" step="0.01" onchange="recalculate()">
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span th:text="#{orders.tax}">Tax</span>
                            <span id="displayTax" th:text="${#numbers.formatCurrency(form.taxAmount)}">0</span>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between mb-2 fs-5 fw-bold">
                            <span th:text="#{orders.grandTotal}">Grand Total</span>
                            <span id="displayGrandTotal" th:text="${#numbers.formatCurrency(form.grandTotal)}">5500</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="d-flex justify-content-between">
                    <a th:href="@{/orders/wizard/back/5}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> <span th:text="#{common.back}">Back</span>
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> <span th:text="#{orders.createOrder}">Create Order</span>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const csrfToken = [[${_csrf.token}]];
        const csrfHeader = [[${_csrf.headerName}]];

        function recalculate() {
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;

            fetch('/orders/wizard/step5/recalculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ discountPercent, taxPercent })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('displayMenuSubtotal').textContent = formatCurrency(result.menuSubtotal);
                    document.getElementById('displayUtilitySubtotal').textContent = formatCurrency(result.utilitySubtotal);
                    document.getElementById('displaySubtotal').textContent = formatCurrency(result.subtotal);
                    document.getElementById('displayDiscount').textContent = '-' + formatCurrency(result.discountAmount);
                    document.getElementById('displayTax').textContent = formatCurrency(result.taxAmount);
                    document.getElementById('displayGrandTotal').textContent = formatCurrency(result.grandTotal);
                }
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(value);
        }
    </script>
</th:block>
</body>
</html>
